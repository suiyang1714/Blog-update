## 引子 ##
> 第一篇日志是23号更新的，这篇的一部分是也是23号写的，但恰逢休假与团建之后大量的工作堆积，拖到了现在，导致再一次拾笔有些茫然了。

## 4.后台管理新增对用户操作 ##
### 删除用户信息 ###
在本地和线上也是做了大量用户测试，所以很多用户信息应该给予删除，进入数据库终端删除有点费劲，索性直接将这个功能做一下，为下一步“是否允许该用户评论”、“评论通过问题”这几个还在萌芽中的功能做一下热身。

### 同时删除该用户评论？ ###
按理说我的每条评论都是通过 *populate* 来关联的，如果该 *user* 的信息找不到，肯定报错，所以，删掉用户的同时也应该一起删掉该用户的所有相关评论。

### 本地存储的 localStorage 来判断是否注册 ###

原先的写法比较简陋，将用户信息存储在本地，只要能读取到本地的用户信息就不走注册的接口来判断(后来加了用户是否注册的判断，评论那里没有修改)。我在测试过程中，删掉了用户相关的所有信息，本身已经存在的用户并不知晓，继续评论，然后断掉了整个服务。

## 5.后台管理新增对评论的操作 ##

### 删掉评论涉及到问题 ###
当初建立模型的时候是这样的：

```
var CommentSchema = new Schema({
    articles: {
        type:ObjectId,
        ref:'article'
    },
    from: {
        type:ObjectId,
        ref:'User'
    },
    reply:[{
        from: {type:ObjectId,ref:'User'},
        to: {type:ObjectId,ref:'User'},
        content:String,
        updateTime:String
    }],
    content:String,
    meta:{
        createAt:{
            type:Date,
            default:Date.now()
        },
        updateAt:{
            type:Date,
            default:Date.now()
        }
    }
})

```
评论的回复是评论的一个数组对象，并没有独立的 *_id* ，在对这些回复数据处理的时候需要多加一个字段，这就比较麻烦了，相比重新修改模型这样也好多了=。

## 6.ajax请求时间过长问题 ##
### 前提 ###
![image](http://or8aa6mih.bkt.clouddn.com/%E5%BE%AE%E4%BF%A1%E5%9B%BE%E7%89%87_20170821171105.png)  
上图可以看出：ajax请求加载页面时，尽管会获取的内容很小（几百B）但是网络相应时间却非常长，主要集中在 *Content Download*。

### 通常产生原因解决措施 ###
Content Download（下载）指的是下载HTTP响应的时间（包含头部和响应体）。通过百度查到的资料有限：  
1、通过条件Get请求，对比If-Modified-Since和Last-Modified时间，确定是否使用缓存中的组件，服务器会返回“304 Not Modified”状态码，减小响应的大小；

2、移除重复脚本，精简和压缩代码，如借助自动化构建工具grunt、gulp等；

3、压缩响应内容，服务器端启用gzip压缩，可以减少下载时间；

但对于我的项目来说，我做的只能优化精简一下代码。   
前面我也说了，对这个问题我是毫无头绪，因为在本地打开网站html渲染和异步都是很快就搞定的，但是线上就非常慢了，我忘了以前是否有这个毛病。
所以这个问题留到了最后解决，就在刚刚我先将修改的代码在本地测试了一遍，功能完好，上传到服务器，然后测试。发现让我头疼的问题竟然解决了。
![image](http://or8aa6mih.bkt.clouddn.com/%E5%BE%AE%E4%BF%A1%E5%9B%BE%E7%89%87_20170830113008.png)

最后总结了下原因，应该是之前的评论 *bug* 导致一直重启服务然后请求。我看之前的pm2 log 日志，重启长达100多次。

## 总结 ##

最终在这个月结束之前解决了一部分 *bug*，唯一的遗憾就是 *es6* 的笔记还有整理完，早在中旬就全部看完了，只差实际应用了，目前写的代码也是开始运用一些简单的语法了，很不习惯，也很不熟悉。  

对于下一步的博客的更新就是不断地测试找 *bug*了，明确的更新还是评论部分的内容:
* 敏感词汇的识别，以及emoji表情字符处理；
* vue的代码的整理（写的很low）；
* ...

九月份的任务？走一步看一步。  
开玩笑。  
应该是先把 *es6* 笔记完，然后 *js* 对象那一块在整理下。  
还有时间就背背词汇了。  
> 革命尚未成功同志仍需努力